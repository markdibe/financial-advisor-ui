<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-left">
            <h1>Financial Advisor AI</h1>
            <span class="subtitle">Ask me anything about your clients</span>
        </div>
        <div class="header-right">
            <button class="btn-emails" (click)="toggleEmailPanel()" [class.active]="showEmailPanel">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
        >
          <path
            d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
            stroke-width="2"
          />
          <path d="M22 6l-10 7L2 6" stroke-width="2" />
        </svg>
        <span>Emails</span>
        <span *ngIf="syncStatus?.emailCount" class="email-badge">{{
          syncStatus?.emailCount
        }}</span>
      </button>
            <span class="user-email">{{ currentUser?.email }}</span>
            <button class="btn-clear" (click)="clearChat()" title="Clear chat">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
        >
          <path
            d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
      </button>
            <button class="btn-logout" (click)="logout()">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <!-- Email Sidebar -->
        <div class="email-sidebar" [class.open]="showEmailPanel">
            <div class="email-sidebar-header">
                <h3>üìß Gmail</h3>
                <button class="btn-sync" (click)="syncEmails()" [disabled]="isSyncing">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            [class.spinning]="isSyncing"
          >
            <path
              d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"
              stroke-width="2"
            />
          </svg>
          {{ isSyncing ? "Syncing..." : "Sync" }}
        </button>
            </div>

            <div class="email-sync-info" *ngIf="syncStatus">
                <small *ngIf="syncStatus.lastSync">
          Last sync: {{ syncStatus.lastSync | date : "short" }}
        </small>
                <small *ngIf="!syncStatus.hasSynced" class="sync-prompt">
          Click Sync to import your emails
        </small>
            </div>

            <!-- NEW: HubSpot Section in Sidebar -->
            <div class="sidebar-section hubspot-section">
                <div class="section-header">
                    <h3>üî∂ HubSpot CRM</h3>
                    <span class="connection-badge" [class.connected]="hubspotConnected">
            {{ hubspotConnected ? "‚úì Connected" : "‚úó Not Connected" }}
          </span>
                </div>

                <!-- Connect Button (when not connected) -->
                <button *ngIf="!hubspotConnected" class="btn-connect-hubspot" (click)="connectHubSpot()">
          Connect HubSpot
        </button>

                <!-- HubSpot Controls (when connected) -->
                <div *ngIf="hubspotConnected" class="hubspot-controls">
                    <button class="btn-sync" (click)="syncHubSpot()" [disabled]="isSyncingHubSpot">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              [class.spinning]="isSyncingHubSpot"
            >
              <path
                d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"
                stroke-width="2"
              />
            </svg>
            {{ isSyncingHubSpot ? "Syncing..." : "Sync HubSpot" }}
          </button>

                    <!-- Stats Summary -->
                    <div class="hubspot-stats">
                        <div class="stat-item">
                            <span class="stat-icon">üë•</span>
                            <span class="stat-value">{{ contactCount }}</span>
                            <span class="stat-label">Contacts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üè¢</span>
                            <span class="stat-value">{{ companyCount }}</span>
                            <span class="stat-label">Companies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üíº</span>
                            <span class="stat-value">{{ dealCount }}</span>
                            <span class="stat-label">Deals</span>
                        </div>
                    </div>

                    <!-- Toggle Details -->
                    <button class="btn-toggle-details" (click)="toggleHubSpotDetails()">
            <span>{{
              showHubSpotDetails ? "‚ñº Hide Details" : "‚ñ∂ Show Details"
            }}</span>
          </button>
                </div>

                <!-- HubSpot Details Panel -->
                <div *ngIf="hubspotConnected && showHubSpotDetails" class="hubspot-details">
                    <!-- Recent Contacts -->
                    <div class="detail-section" *ngIf="contacts.length > 0">
                        <h4>Recent Contacts</h4>
                        <div class="contact-list">
                            <div class="contact-item" *ngFor="let contact of contacts.slice(0, 5)">
                                <div class="contact-name">
                                    {{ contact.firstName }} {{ contact.lastName }}
                                </div>
                                <div class="contact-details">
                                    <div *ngIf="contact.email" class="detail-row">
                                        <span class="icon">‚úâÔ∏è</span>
                                        <span class="text">{{ contact.email }}</span>
                                    </div>
                                    <div *ngIf="contact.company" class="detail-row">
                                        <span class="icon">üè¢</span>
                                        <span class="text">{{ contact.company }}</span>
                                    </div>
                                    <div *ngIf="contact.jobTitle" class="detail-row">
                                        <span class="icon">üíº</span>
                                        <span class="text">{{ contact.jobTitle }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Deals -->
                    <div class="detail-section" *ngIf="deals.length > 0">
                        <h4>Recent Deals</h4>
                        <div class="deal-list">
                            <div class="deal-item" *ngFor="let deal of deals.slice(0, 5)">
                                <div class="deal-name">{{ deal.dealName }}</div>
                                <div class="deal-details">
                                    <div *ngIf="deal.amount" class="detail-row">
                                        <span class="icon">üí∞</span>
                                        <span class="text">${{ deal.amount | number : "1.0-0" }}</span
                    >
                  </div>
                  <div class="detail-row">
                    <span class="icon">üìä</span>
                                        <span class="text">{{ deal.dealStage }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Companies -->
                    <div class="detail-section" *ngIf="companies.length > 0">
                        <h4>Recent Companies</h4>
                        <div class="company-list">
                            <div class="company-item" *ngFor="let company of companies.slice(0, 5)">
                                <div class="company-name">{{ company.name }}</div>
                                <div class="company-details">
                                    <div *ngIf="company.industry" class="detail-row">
                                        <span class="text">{{ company.industry }}</span>
                                    </div>
                                    <div *ngIf="company.city" class="detail-row">
                                        <span class="icon">üìç</span>
                                        <span class="text">{{ company.city }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END: HubSpot Section -->

            <!-- Original Email List -->
            <div class="email-list" *ngIf="!isLoadingEmails && emails.length > 0">
                <div class="email-item" *ngFor="let email of emails" [class.unread]="!email.isRead">
                    <div class="email-item-header">
                        <span class="email-from">{{ email.fromEmail }}</span>
                        <span class="email-date">{{
              email.emailDate | date : "MMM d"
            }}</span>
                    </div>
                    <div class="email-subject">{{ email.subject }}</div>
                    <div class="email-snippet">{{ email.snippet }}</div>
                </div>
            </div>

            <div class="email-loading" *ngIf="isLoadingEmails">
                <div class="spinner-small"></div>
                <p>Loading emails...</p>
            </div>

            <div class="email-empty" *ngIf="!isLoadingEmails && emails.length === 0 && syncStatus?.hasSynced">
                <p>No emails found</p>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-wrapper" [class.sidebar-open]="showEmailPanel">
            <div class="messages-container" #messagesContainer>
                <!-- Loading State -->
                <div *ngIf="isLoading" class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading chat history...</p>
                </div>

                <!-- Empty State -->
                <div *ngIf="!isLoading && messages.length === 0" class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path
              d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
                    <h3>Start a conversation</h3>
                    <p>
                        Ask me about your clients, schedule meetings, or manage your tasks.
                    </p>
                    <div class="example-prompts">
                        <button class="example-prompt" (click)="newMessage = 'Who are my recent clients?'; sendMessage()">
              Who are my recent clients?
            </button>
                        <button class="example-prompt" (click)="
                newMessage = 'What meetings do I have this week?'; sendMessage()
              ">
              What meetings do I have this week?
            </button>
                        <button class="example-prompt" (click)="
                newMessage = 'Help me draft an email to a client'; sendMessage()
              ">
              Help me draft an email
            </button>
                    </div>
                </div>

                <!-- Messages -->
                <div *ngFor="let message of messages" class="message" [class.user-message]="message.role === 'user'" [class.assistant-message]="message.role === 'assistant'">
                    <div class="message-avatar">
                        <span *ngIf="message.role === 'user'">üë§</span>
                        <span *ngIf="message.role === 'assistant'">ü§ñ</span>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-role">{{
                message.role === "user" ? "You" : "AI Assistant"
              }}</span>
                            <span class="message-time">{{
                message.createdAt | date : "short"
              }}</span>
                        </div>
                        <div class="message-text">{{ message.content }}</div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div *ngIf="isSending" class="message assistant-message typing-indicator">
                    <div class="message-avatar">
                        <span>ü§ñ</span>
                    </div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea [(ngModel)]="newMessage" (keypress)="onKeyPress($event)" placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)" rows="1" [disabled]="isSending" class="message-input"></textarea>
                    <button class="btn-send" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSending" [class.sending]="isSending">
            <svg
              *ngIf="!isSending"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <div *ngIf="isSending" class="button-spinner"></div>
          </button>
                </div>
            </div>
        </div>
    </div>
</div>